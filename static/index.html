<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blender Batch Submitter</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .animate-spin {
            animation: spin 1s linear infinite;
        }

        /* Modal animations */
        #scriptModal {
            transition: opacity 0.2s ease-in-out;
        }

        #scriptModal > div > div {
            animation: slideUp 0.3s ease-out;
        }

        @keyframes slideUp {
            from { 
                opacity: 0;
                transform: translateY(20px);
            }
            to { 
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Code styling */
        #scriptContent {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            tab-size: 4;
            line-height: 1.5;
            padding-top: 1rem;
            padding-bottom: 1rem;
        }

        /* Line numbers styling */
        #lineNumbers {
            user-select: none;
            line-height: 1.5;
            padding-top: 1rem;
            padding-bottom: 1rem;
        }
        
        #lineNumbers div {
            height: 1.5rem;
            line-height: 1.5rem;
        }

        /* Syntax highlighting colors */
        .text-purple-400 { color: #c084fc; }    /* Keywords */
        .text-blue-400 { color: #60a5fa; }      /* Builtins */
        .text-yellow-400 { color: #fbbf24; }    /* Strings */
        .text-green-400 { color: #4ade80; }     /* Comments */
        .text-orange-400 { color: #fb923c; }    /* Numbers */
        
        /* Plain text view */
        .whitespace-pre {
            white-space: pre;
            tab-size: 4;
            line-height: 1.5;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 text-white min-h-screen">
    <div id="app" class="p-3 w-[98vw] mx-auto h-[100vh] flex flex-col">
        <div class="mb-8">
            <h1 class="text-4xl font-bold mb-2 bg-gradient-to-r from-blue-400 to-purple-500 bg-clip-text text-transparent">
                CGRU Batch Submitter
            </h1>
            <p class="text-slate-400">Automate CGRU submission for multiple blend files</p>
        </div>

        <div class="flex gap-4 flex-1 overflow-hidden">
            <!-- Main Content Area -->
            <div class="flex-[50] space-y-4 overflow-y-auto">
                <!-- Paths Configuration -->
                <div class="bg-slate-800 rounded-lg p-6 border border-slate-700">
                    <h2 class="text-xl font-semibold mb-4">üìÅ Paths Configuration</h2>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium mb-2 text-slate-300">Target Directory</label>
                            <div class="flex gap-2">
                                <input type="text" id="targetDir"
                                       placeholder="Click Browse or type path: M:\BM3_Gurlatan_Arc\2_Reel\..."
                                       class="flex-1 bg-slate-900 border border-slate-600 rounded px-4 py-2 focus:outline-none focus:border-blue-500">
                                <button onclick="browseFolder()" 
                                        class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded transition-colors whitespace-nowrap">
                                    üìÅ Browse
                                </button>
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-medium mb-2 text-slate-300">Blender Version</label>
                            <select id="blenderVersion" onchange="updateBlenderPath()"
                                    class="w-full bg-slate-900 border border-slate-600 rounded px-4 py-2 focus:outline-none focus:border-blue-500">
                                <option value="">Loading Blender installations...</option>
                            </select>
                            <div class="flex gap-2 mt-2">
                                <input type="text" id="blenderPath"
                                       placeholder="Or type custom path"
                                       class="flex-1 bg-slate-900 border border-slate-600 rounded px-4 py-2 text-sm focus:outline-none focus:border-blue-500">
                                <button onclick="detectBlender()" 
                                        class="bg-green-600 hover:bg-green-700 px-3 py-2 rounded text-sm transition-colors whitespace-nowrap">
                                    üîç Detect
                                </button>
                            </div>
                            <p class="text-xs text-slate-400 mt-1">Select version or provide custom path</p>
                        </div>
                    </div>
                </div>

                <!-- Exclude Patterns -->
                <div class="bg-slate-800 rounded-lg p-6 border border-slate-700">
                    <h2 class="text-xl font-semibold mb-4">üö´ Exclude Patterns</h2>
                    
                    <div class="flex gap-2 mb-3">
                        <input type="text" id="newPattern" 
                               placeholder="Add pattern (e.g., .blend1)"
                               class="flex-1 bg-slate-900 border border-slate-600 rounded px-4 py-2 focus:outline-none focus:border-blue-500">
                        <button onclick="addPattern()" 
                                class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded transition-colors">
                            Add
                        </button>
                    </div>

                    <div id="patternsList" class="flex flex-wrap gap-2"></div>
                </div>

                <!-- Found Files -->
                <div class="bg-slate-800 rounded-lg p-6 border border-slate-700">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold">üìÑ Scanned Files (<span id="scannedCount">0</span>)</h2>
                        <div class="flex gap-2">
                            <button onclick="selectAllFiles()" 
                                    class="text-xs bg-slate-700 hover:bg-slate-600 px-3 py-1 rounded transition-colors">
                                Select All
                            </button>
                            <button onclick="deselectAllFiles()" 
                                    class="text-xs bg-slate-700 hover:bg-slate-600 px-3 py-1 rounded transition-colors">
                                Deselect All
                            </button>
                        </div>
                    </div>
                    
                    <button onclick="scanFiles()" 
                            class="w-full bg-green-600 hover:bg-green-700 px-4 py-2 rounded mb-3 transition-colors">
                        üîç Scan Directory
                    </button>

                    <div id="filesList" class="max-h-40 overflow-y-auto space-y-1 mb-3"></div>
                    
                    <button onclick="addSelectedToQueue()" id="addToQueueBtn" disabled
                            class="w-full bg-blue-600 hover:bg-blue-700 disabled:bg-slate-700 disabled:cursor-not-allowed px-4 py-2 rounded transition-colors">
                        ‚ûï Add Selected to Submit Queue
                    </button>
                </div>
                
                <!-- Submit Queue -->
                <div class="bg-slate-800 rounded-lg p-6 border border-slate-700">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold">üìã Submit Queue (<span id="queueCount">0</span>)</h2>
                        <button onclick="clearQueue()" 
                                class="text-xs bg-red-700 hover:bg-red-600 px-3 py-1 rounded transition-colors">
                            Clear Queue
                        </button>
                    </div>
                    
                    <div id="queueList" class="max-h-40 overflow-y-auto space-y-1">
                        <div class="text-slate-500 text-center py-4">No files queued</div>
                    </div>
                </div>

                <!-- Run Buttons -->
                <div class="flex gap-2">
                    <button onclick="runBatch()" id="runButton"
                            class="flex-1 bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 disabled:from-slate-700 disabled:to-slate-700 disabled:cursor-not-allowed px-6 py-4 rounded-lg font-semibold text-lg transition-all">
                        ‚ñ∂Ô∏è Run Batch Submission
                    </button>
                    <button onclick="cancelBatch()" id="cancelButton" style="display: none;"
                            class="bg-red-600 hover:bg-red-700 px-6 py-4 rounded-lg font-semibold text-lg transition-all">
                        ‚èπÔ∏è Cancel
                    </button>
                </div>
            </div>

            <!-- Right Log Column -->
            <div class="flex-[50] flex flex-col space-y-6 overflow-y-auto">
                <!-- Script Selection -->
                <div class="bg-slate-800 rounded-lg p-3 border border-slate-700">
                    <h2 class="text-xl font-semibold mb-4">üìú Script Selection</h2>
                    
                    <div class="space-y-3 mb-4">
                        <div class="flex items-center gap-2">
                            <input type="radio" id="useDefaultScript" name="scriptMode" value="default" checked class="w-4 h-4">
                            <label for="useDefaultScript" class="text-sm flex-1">Use Default Script (cgru_submitDEFAULT.py)</label>
                            <button onclick="viewDefaultScript()" class="text-slate-400 hover:text-slate-300" title="View default script">
                                üëÅÔ∏è
                            </button>
                        </div>
                        <div class="flex items-center gap-2">
                            <input type="radio" id="useCustomScript" name="scriptMode" value="custom" class="w-4 h-4">
                            <label for="useCustomScript" class="text-sm flex-1">Use Custom Script Settings</label>
                        </div>
                    </div>
                    
                    <div class="text-xs text-slate-400 mb-4">
                        Default script provides base settings. Custom mode lets you override with your own settings below.
                    </div>
                </div>

                <!-- Custom Settings -->
                <div class="bg-slate-800 rounded-lg p-3 border border-slate-700">
                    <h2 class="text-xl font-semibold mb-4">‚öôÔ∏è CGRU Settings</h2>
                    
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-sm mb-1">Frames per Task</label>
                            <input type="number" id="fpertask" value="3" min="1"
                                   class="w-full bg-slate-900 border border-slate-600 rounded px-3 py-2 text-sm focus:outline-none focus:border-blue-500">
                        </div>
                        
                        <div class="flex items-center gap-2 mt-6">
                            <input type="checkbox" id="pause" class="w-4 h-4">
                            <label class="text-sm">Pause after submit</label>
                        </div>
                        
                        <div class="flex items-center gap-2">
                            <input type="checkbox" id="relativePaths" checked class="w-4 h-4">
                            <label class="text-sm">Relative Paths</label>
                        </div>
                        
                        <div class="flex items-center gap-2">
                            <input type="checkbox" id="useAllScenes" class="w-4 h-4">
                            <label class="text-sm">Use All Scenes</label>
                        </div>
                    </div>
                    
                    <label class="block text-sm font-medium mb-2">Custom Python Code (Optional)</label>
                    <textarea id="customCode" rows="6"
                              class="w-full bg-slate-900 border border-slate-600 rounded px-4 py-2 font-mono text-sm focus:outline-none focus:border-blue-500"
                              placeholder="# Add custom Python code here, e.g.:
# bpy.data.scenes['_Main'].render.resolution_x = 2048
# bpy.data.scenes['FX'].render.engine = 'CYCLES'
# bpy.data.scenes['RIM'].view_layers['ViewLayer'].use = True
# in blender, right click properties to copy python command and select copy full data path"></textarea>
                    
                    <p class="text-xs text-slate-400 mt-2">
                        Settings will be applied before bpy.ops.cgru.submit()
                    </p>
                </div>



                <!-- Progress Bar -->
                <div id="progressBar" class="bg-slate-800 rounded-lg p-2 border border-slate-700 hidden">
                    <h2 class="text-lg font-semibold mb-3">‚è≥ Progress</h2>
                    <div class="mb-2">
                        <div class="flex justify-between text-sm mb-1">
                            <span id="progressText">Processing...</span>
                            <span id="progressPercent">0%</span>
                        </div>
                        <div class="w-full bg-slate-900 rounded-full h-3">
                            <div id="progressFill" class="bg-gradient-to-r from-blue-500 to-purple-500 h-3 rounded-full transition-all" style="width: 0%"></div>
                        </div>
                    </div>
                    <p class="text-sm text-slate-400" id="currentFile"></p>
                </div>

                <!-- Logs -->
                <div class="bg-slate-800 rounded-lg p-3 border border-slate-700 flex-1 flex flex-col">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold">üìã Execution Log</h2>
                        <div class="flex gap-2">
                            <button onclick="saveLogsToFile()" 
                                    class="text-sm bg-slate-700 hover:bg-slate-600 px-3 py-1 rounded transition-colors"
                                    title="Save logs to file">
                                üíæ Save
                            </button>
                            <button onclick="copyLogsToClipboard()" 
                                    class="text-sm bg-slate-700 hover:bg-slate-600 px-3 py-1 rounded transition-colors"
                                    title="Copy logs to clipboard">
                                üìã Copy
                            </button>
                            <button onclick="clearLogs()" 
                                    class="text-sm bg-slate-700 hover:bg-slate-600 px-3 py-1 rounded transition-colors">
                                Clear
                            </button>
                        </div>
                    </div>
                    
                    <div id="logs" class="bg-slate-900 rounded p-4 flex-1 overflow-y-auto font-mono text-xs space-y-1">
                        <div class="text-slate-500">Ready to process files...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Script Viewer Modal -->
    <div id="scriptModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-slate-800 rounded-lg max-w-4xl w-full max-h-[80vh] flex flex-col">
                <!-- Header -->
                <div class="flex justify-between items-center p-4 border-b border-slate-700">
                    <div class="flex items-center gap-4">
                        <h3 class="text-lg font-semibold">Default CGRU Script</h3>
                        <div class="flex items-center gap-2">
                            <label class="text-sm">View:</label>
                            <div class="flex gap-2">
                                <label class="flex items-center gap-1 text-sm">
                                    <input type="radio" name="scriptView" value="highlighted" onchange="toggleScriptView()" class="w-3 h-3">
                                    <span>Highlighted</span>
                                </label>
                                <label class="flex items-center gap-1 text-sm">
                                    <input type="radio" name="scriptView" value="plain" checked onchange="toggleScriptView()" class="w-3 h-3">
                                    <span>Plain Text</span>
                                </label>
                            </div>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="copyScriptToClipboard()" class="text-blue-400 hover:text-blue-300 px-3 py-1 rounded text-sm">
                            üìã Copy
                        </button>
                        <button onclick="closeScriptModal()" class="text-slate-400 hover:text-slate-300 px-3 py-1 rounded text-sm">
                            ‚úï
                        </button>
                    </div>
                </div>
                <!-- Script content with line numbers -->
                <div class="flex-1 flex overflow-hidden">
                    <div id="lineNumbers" class="bg-slate-900 text-slate-500 text-right px-3 py-4 text-sm font-mono border-r border-slate-700 overflow-hidden min-w-[50px]">
                        <!-- Line numbers will be inserted here -->
                    </div>
                    <div id="scriptContent" class="flex-1 bg-slate-900 p-4 overflow-auto font-mono text-sm">
                        <!-- Script content with syntax highlighting will be inserted here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let excludePatterns = ['.blend1', '.2025'];
        let scannedFiles = [];
        let selectedFiles = [];
        let submitQueue = [];
        let statusInterval = null;

        // Wait for pywebview to be ready
        window.addEventListener('pywebviewready', function() {
            console.log('PyWebView ready!');
            addLog('success', 'Application ready');
            detectBlender(); // Auto-detect Blender on startup
        });

        // Global function for backend to update logs
        window.updateLogs = function(logs) {
            const logsContainer = document.getElementById('logs');
            logsContainer.innerHTML = logs.map(log => {
                const colorClass = 
                    log.type === 'success' ? 'text-green-400' :
                    log.type === 'error' ? 'text-red-400' :
                    log.type === 'warning' ? 'text-yellow-400' : 'text-blue-400';
                
                return `<div class="${colorClass}">[${log.timestamp}] ${log.msg}</div>`;
            }).join('');
            logsContainer.scrollTop = logsContainer.scrollHeight;
        };

        async function scanFiles() {
            const targetDir = document.getElementById('targetDir').value;
            if (!targetDir) {
                alert('Please enter a target directory first');
                return;
            }

            addLog('info', `Scanning directory: ${targetDir}`);
            
            try {
                const result = await pywebview.api.scan_files(targetDir, excludePatterns);
                
                if (result.success) {
                    scannedFiles = result.files;
                    selectedFiles = []; // Reset selection
                    document.getElementById('scannedCount').textContent = result.count;
                    
                    renderFilesList();
                    updateAddToQueueButton();
                    
                    addLog('success', `Found ${result.count} blend files`);
                } else {
                    addLog('error', `Scan failed: ${result.error}`);
                }
            } catch (error) {
                addLog('error', `Scan error: ${error.message}`);
            }
        }
        
        function renderFilesList() {
            const filesList = document.getElementById('filesList');
            filesList.innerHTML = scannedFiles.length > 0 
                ? scannedFiles.map((file, idx) => {
                    const isSelected = selectedFiles.includes(idx);
                    return `
                        <div class="flex items-center gap-2 bg-slate-900 px-3 py-2 rounded hover:bg-slate-700 transition-colors">
                            <input type="checkbox" 
                                   id="file_${idx}" 
                                   ${isSelected ? 'checked' : ''}
                                   onchange="toggleFileSelection(${idx})"
                                   class="w-4 h-4">
                            <label for="file_${idx}" class="flex-1 text-sm cursor-pointer flex justify-between">
                                <span>${file.name}</span>
                                <span class="text-slate-500">${formatBytes(file.size)}</span>
                            </label>
                        </div>
                    `;
                }).join('')
                : '<div class="text-slate-500 text-center py-4">No files found</div>';
        }
        
        function toggleFileSelection(index) {
            const idx = selectedFiles.indexOf(index);
            if (idx >= 0) {
                selectedFiles.splice(idx, 1);
            } else {
                selectedFiles.push(index);
            }
            updateAddToQueueButton();
        }
        
        function selectAllFiles() {
            selectedFiles = scannedFiles.map((_, idx) => idx);
            renderFilesList();
            updateAddToQueueButton();
            addLog('info', `Selected all ${selectedFiles.length} files`);
        }
        
        function deselectAllFiles() {
            selectedFiles = [];
            renderFilesList();
            updateAddToQueueButton();
            addLog('info', 'Deselected all files');
        }
        
        function updateAddToQueueButton() {
            const btn = document.getElementById('addToQueueBtn');
            btn.disabled = selectedFiles.length === 0;
            btn.textContent = selectedFiles.length > 0 
                ? `‚ûï Add ${selectedFiles.length} Selected to Submit Queue`
                : '‚ûï Add Selected to Submit Queue';
        }
        
        function addSelectedToQueue() {
            const filesToAdd = selectedFiles.map(idx => scannedFiles[idx]);
            
            // Avoid duplicates
            filesToAdd.forEach(file => {
                if (!submitQueue.some(f => f.path === file.path)) {
                    submitQueue.push(file);
                }
            });
            
            // Clear selection
            selectedFiles = [];
            renderFilesList();
            renderQueue();
            updateAddToQueueButton();
            
            addLog('success', `Added ${filesToAdd.length} files to submit queue`);
        }
        
        function renderQueue() {
            const queueList = document.getElementById('queueList');
            document.getElementById('queueCount').textContent = submitQueue.length;
            
            queueList.innerHTML = submitQueue.length > 0 
                ? submitQueue.map((file, idx) => `
                    <div class="flex items-center gap-2 bg-slate-900 px-3 py-2 rounded group">
                        <span class="flex-1 text-sm flex justify-between">
                            <span>${file.name}</span>
                            <span class="text-slate-500">${formatBytes(file.size)}</span>
                        </span>
                        <button onclick="removeFromQueue(${idx})" 
                                class="text-red-400 hover:text-red-300 opacity-0 group-hover:opacity-100 transition-opacity">
                            ‚úï
                        </button>
                    </div>
                `).join('')
                : '<div class="text-slate-500 text-center py-4">No files queued</div>';
        }
        
        function removeFromQueue(index) {
            const file = submitQueue[index];
            submitQueue.splice(index, 1);
            renderQueue();
            addLog('info', `Removed ${file.name} from queue`);
        }
        
        function clearQueue() {
            if (submitQueue.length === 0) return;
            const count = submitQueue.length;
            submitQueue = [];
            renderQueue();
            addLog('info', `Cleared ${count} files from queue`);
        }

        function renderPatterns() {
            const container = document.getElementById('patternsList');
            container.innerHTML = excludePatterns.map((pattern, idx) => `
                <div class="bg-slate-900 px-3 py-1 rounded-full flex items-center gap-2">
                    <span class="text-sm">${pattern}</span>
                    <button onclick="removePattern(${idx})" class="text-red-400 hover:text-red-300 font-bold">√ó</button>
                </div>
            `).join('');
        }

        function addPattern() {
            const input = document.getElementById('newPattern');
            const pattern = input.value.trim();
            if (pattern && !excludePatterns.includes(pattern)) {
                excludePatterns.push(pattern);
                input.value = '';
                renderPatterns();
            }
        }

        function removePattern(index) {
            excludePatterns.splice(index, 1);
            renderPatterns();
        }



        async function runBatch() {
            if (submitQueue.length === 0) {
                alert('No files in submit queue. Select files and add them to queue first.');
                return;
            }

            const blenderPath = document.getElementById('blenderPath').value;
            if (!blenderPath) {
                alert('Please enter Blender executable path');
                return;
            }

            const scriptMode = document.querySelector('input[name="scriptMode"]:checked').value;
            
            const config = {
                files: submitQueue,
                blenderPath: blenderPath,
                useCustomScript: scriptMode === 'custom',
                cgruSettings: {
                    fpertask: parseInt(document.getElementById('fpertask').value),
                    pause: document.getElementById('pause').checked,
                    relativePaths: document.getElementById('relativePaths').checked,
                    use_all_scenes: document.getElementById('useAllScenes').checked
                },
                customCode: document.getElementById('customCode').value
            };

            try {
                const result = await pywebview.api.submit_jobs(config);
                
                if (result.success) {
                    document.getElementById('progressBar').classList.remove('hidden');
                    document.getElementById('runButton').disabled = true;
                    document.getElementById('cancelButton').style.display = 'block';
                    startStatusPolling();
                } else {
                    addLog('error', result.error);
                }
            } catch (error) {
                addLog('error', `Run error: ${error.message}`);
            }
        }
        
        async function cancelBatch() {
            if (!confirm('Are you sure you want to cancel? The current file will be terminated immediately.')) {
                return;
            }
            
            try {
                const result = await pywebview.api.cancel_submission();
                if (result.success) {
                    addLog('warning', result.message);
                    document.getElementById('cancelButton').disabled = true;
                    document.getElementById('cancelButton').textContent = 'Cancelling...';
                } else {
                    addLog('error', result.message);
                }
            } catch (error) {
                addLog('error', `Cancel error: ${error.message}`);
            }
        }

        function startStatusPolling() {
            if (statusInterval) clearInterval(statusInterval);
            
            statusInterval = setInterval(async () => {
                try {
                    const status = await pywebview.api.get_status();
                    
                    // Update progress
                    if (status.total > 0) {
                        const percent = Math.round((status.progress / status.total) * 100);
                        document.getElementById('progressFill').style.width = `${percent}%`;
                        document.getElementById('progressPercent').textContent = `${percent}%`;
                        document.getElementById('progressText').textContent = `${status.progress} / ${status.total}`;
                        document.getElementById('currentFile').textContent = status.current_file;
                    }
                    
                    // Update logs
                    window.updateLogs(status.logs);
                    
                    // Stop polling if done
                    if (!status.is_running && status.progress > 0) {
                        clearInterval(statusInterval);
                        document.getElementById('runButton').disabled = false;
                        document.getElementById('cancelButton').style.display = 'none';
                        document.getElementById('cancelButton').disabled = false;
                        document.getElementById('cancelButton').textContent = '‚èπÔ∏è Cancel';
                    }
                } catch (error) {
                    console.error('Status poll error:', error);
                }
            }, 500);
        }

        function addLog(type, msg) {
            const logsContainer = document.getElementById('logs');
            const timestamp = new Date().toLocaleTimeString();
            const colorClass = 
                type === 'success' ? 'text-green-400' :
                type === 'error' ? 'text-red-400' :
                type === 'warning' ? 'text-yellow-400' : 'text-blue-400';
            
            const logEntry = `<div class="${colorClass}">[${timestamp}] ${msg}</div>`;
            
            if (logsContainer.innerHTML.includes('Ready to process')) {
                logsContainer.innerHTML = logEntry;
            } else {
                logsContainer.innerHTML += logEntry;
            }
            logsContainer.scrollTop = logsContainer.scrollHeight;
        }

        function clearLogs() {
            document.getElementById('logs').innerHTML = '<div class="text-slate-500">Logs cleared...</div>';
        }

        function formatBytes(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        }

        async function browseFolder() {
            try {
                const result = await pywebview.api.browse_folder();
                if (result.success) {
                    document.getElementById('targetDir').value = result.path;
                    addLog('info', `Selected folder: ${result.path}`);
                }
            } catch (error) {
                addLog('error', `Browse folder error: ${error.message}`);
            }
        }

        async function detectBlender() {
            try {
                const installations = await pywebview.api.find_blender_installations();
                const select = document.getElementById('blenderVersion');
                
                if (installations && installations.length > 0) {
                    select.innerHTML = installations.map(install => 
                        `<option value="${install.path}" data-full-path="${install.full_path}">Blender ${install.version}</option>`
                    ).join('');
                    
                    // Select the newest version by default
                    if (installations.length > 0) {
                        select.value = installations[0].path;
                        document.getElementById('blenderPath').value = installations[0].path;
                        addLog('success', `Found ${installations.length} Blender installations`);
                    }
                } else {
                    select.innerHTML = '<option value="">No Blender installations found</option>';
                    // Keep the fallback path
                    document.getElementById('blenderPath').value = 'D:\\App\\blender\\4.2\\blender.exe';
                    addLog('warning', 'No Blender installations found, using default path');
                }
            } catch (error) {
                addLog('error', `Blender detection error: ${error.message}`);
                // Fallback to manual input
                document.getElementById('blenderVersion').innerHTML = '<option value="">Manual entry</option>';
            }
        }

        function updateBlenderPath() {
            const select = document.getElementById('blenderVersion');
            const pathInput = document.getElementById('blenderPath');
            
            if (select.value) {
                pathInput.value = select.value;
            }
        }

        // Script Viewer Modal Functions
        let scriptModal = null;
        let scriptContent = '';

        function initScriptModal() {
            scriptModal = document.getElementById('scriptModal');
            
            // Escape key to close
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && !scriptModal.classList.contains('hidden')) {
                    closeScriptModal();
                }
            });
            
            // Click backdrop to close
            scriptModal.addEventListener('click', (e) => {
                if (e.target === scriptModal) {
                    closeScriptModal();
                }
            });
        }

        async function viewDefaultScript() {
            try {
                const result = await pywebview.api.get_default_script_content();
                if (result.success) {
                    scriptContent = result.content;
                    showScriptModal(result.content);
                    addLog('info', `Loaded default script (${result.line_count} lines)`);
                    
                    // Remember user opened it
                    localStorage.setItem('scriptViewed', 'true');
                } else {
                    addLog('error', result.error);
                }
            } catch (error) {
                addLog('error', `Failed to load script: ${error.message}`);
            }
        }

        function showScriptModal(content) {
            // Store original content for copying
            scriptContent = content;
            
            // Set plain text as default view
            document.querySelector('input[name="scriptView"][value="plain"]').checked = true;
            document.querySelector('input[name="scriptView"][value="highlighted"]').checked = false;
            
            // Add line numbers
            const lines = content.split('\n');
            const lineNumbers = lines.map((_, i) => {
                const lineNumber = i + 1;
                return `<div>${lineNumber}</div>`;
            }).join('');
            
            // Update content with plain text (default)
            updateScriptView(content, lineNumbers);
            
            // Show modal
            scriptModal.classList.remove('hidden');
            scriptModal.classList.add('flex');
        }

        function updateScriptView(content, lineNumbers) {
            const viewMode = document.querySelector('input[name="scriptView"]:checked').value;
            const scriptContentEl = document.getElementById('scriptContent');
            
            if (viewMode === 'plain') {
                // Show plain text
                scriptContentEl.innerHTML = `<div class="whitespace-pre">${escapeHtml(content)}</div>`;
            } else {
                // Show highlighted
                scriptContentEl.innerHTML = highlightPythonSyntax(content);
            }
            
            document.getElementById('lineNumbers').innerHTML = lineNumbers;
        }

        function toggleScriptView() {
            if (scriptContent) {
                const lines = scriptContent.split('\n');
                const lineNumbers = lines.map((_, i) => {
                    const lineNumber = i + 1;
                    return `<div>${lineNumber}</div>`;
                }).join('');
                
                updateScriptView(scriptContent, lineNumbers);
            }
        }

        function closeScriptModal() {
            scriptModal.classList.add('hidden');
            scriptModal.classList.remove('flex');
        }

        async function copyScriptToClipboard() {
            try {
                await navigator.clipboard.writeText(scriptContent);
                showToast('Script copied to clipboard!');
            } catch (error) {
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = scriptContent;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                showToast('Script copied to clipboard!');
            }
        }

        // Advanced Python syntax highlighting
        function highlightPythonSyntax(code) {
            const keywords = ['import', 'from', 'def', 'class', 'if', 'else', 'elif', 'for', 'while', 
                            'try', 'except', 'with', 'as', 'return', 'pass', 'break', 'continue', 
                            'and', 'or', 'not', 'in', 'is', 'None', 'True', 'False'];
            const builtins = ['print', 'len', 'range', 'str', 'int', 'float', 'list', 'dict', 'set', 'tuple', 'hasattr'];
            
            let html = '';
            const lines = code.split('\n');
            
            lines.forEach(line => {
                let processedLine = escapeHtml(line);
                
                // Highlight comments
                processedLine = processedLine.replace(/(#.*)$/, '<span class="text-green-400 italic">$1</span>');
                
                // Highlight strings
                processedLine = processedLine.replace(/(["'])((?:(?=(\\?))\2.)*?)\1/g, '<span class="text-yellow-400">$1$2$3</span>');
                
                // Highlight keywords
                keywords.forEach(keyword => {
                    const regex = new RegExp(`\\b${keyword}\\b`, 'g');
                    processedLine = processedLine.replace(regex, `<span class="text-purple-400">${keyword}</span>`);
                });
                
                // Highlight builtins
                builtins.forEach(builtin => {
                    const regex = new RegExp(`\\b${builtin}\\b`, 'g');
                    processedLine = processedLine.replace(regex, `<span class="text-blue-400">${builtin}</span>`);
                });
                
                // Highlight numbers
                processedLine = processedLine.replace(/\b(\d+)\b/g, '<span class="text-orange-400">$1</span>');
                
                // Use div for each line to maintain alignment with line numbers
                html += `<div class="leading-6">${processedLine}</div>`;
            });
            
            return html;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Log Copy and Save Functions
        async function copyLogsToClipboard() {
            try {
                const status = await pywebview.api.get_status();
                const logText = formatLogsForCopy(status.logs);
                
                await navigator.clipboard.writeText(logText);
                showToast(`Copied ${status.logs.length} log entries to clipboard!`);
                
                addLog('info', `Copied ${status.logs.length} log entries to clipboard`);
            } catch (error) {
                addLog('error', `Failed to copy logs: ${error.message}`);
            }
        }

        function formatLogsForCopy(logs) {
            if (logs.length === 0) return 'No logs available.';
            
            const header = `CGRU Batch Submitter - Execution Log\n` +
                          `Generated: ${new Date().toLocaleString()}\n` +
                          `Total entries: ${logs.length}\n` +
                          `${'='.repeat(50)}\n\n`;
            
            const logLines = logs.map(log => {
                const icon = log.type === 'success' ? '‚úì' : 
                           log.type === 'error' ? '‚úó' : 
                           log.type === 'warning' ? '‚ö†' : '‚Ñπ';
                return `[${log.timestamp}] ${icon} ${log.msg}`;
            });
            
            return header + logLines.join('\n');
        }

        async function saveLogsToFile() {
            try {
                const result = await pywebview.api.save_logs_to_file();
                if (result.success) {
                    showToast(`Logs saved to: ${result.file_path}`);
                    addLog('info', `Logs saved to file: ${result.file_path}`);
                } else {
                    addLog('error', `Failed to save logs: ${result.error}`);
                }
            } catch (error) {
                addLog('error', `Save error: ${error.message}`);
            }
        }

        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'fixed bottom-4 right-4 bg-green-600 text-white px-4 py-2 rounded-lg shadow-lg z-50 animate-pulse';
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        // Initialize modal when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            initScriptModal();
        });

        // Initialize
        renderPatterns();
    </script>
</body>
</html>